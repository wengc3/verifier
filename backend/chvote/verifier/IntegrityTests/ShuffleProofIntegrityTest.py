import os, sys
from gmpy2 import mpz
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))))

from chvote.verifier.SingleTest import SingleTest
from chvote.Utils.VerifierHelper import completness_decorate
from chvote.verifier.IntegrityTests.multiMathGroupeHelper import multiMathGroupeHelper
from chvote.Common.IsMemberOfGroupe import IsMemberOfGroupe

def multiRangeTestHelper(vector,rng,param):
    try:
        for j in range(rng):
            if not int(vector[j]) in range(param):
                return False
        return True
    except IndexError:
        return False

class ShuffleProofIntegrityTest(SingleTest):
    """docstring for ShuffleProofIntegrityTest."""

    @completness_decorate
    def runTest(self,election_data):
        """
        Test if pi_j in (G_q^3 x G_q^2 x G_q^N) x (Z_q^4 x Z_q^N x Z_q^N) x G_q^N x G_q^N
        >>> res = spit.runTest({'pi_j': [['1480087838687999167062277319226971465937398361948978274707177620948566648158947887443778075355786727283504482872057690365959166730453190661705498994966826611211532915013738003276107626571651493692562622786367479412644735268590556815783391245022975075238800164180689536399270977580972527519394411289783797442934321450170232285313916950968074179587743235918981784470174870877923174520421226017060743488051123269710434092139375033589815933577120323070201479153618533690271564291278766919709242079275351726228669769175956071768754349852181400656573533435625890370039947811031592353292327908040915715284998119942688467277259984379747580274991900799752536064523123588895312969400352579712157808515386261702471479371581552638089473706377244795393548370568509561973714473872948297015756800023897498146994562705194843155909557795876732844431713021058780230349498250949884936366280832566749304369077990485953443189018945331081579260533', '666271631535156629212810650139014919111978117934376212770194555116520156317377673809338778123454387225319467678165313127748703364713982305534906201188528767837819967889126862957837600657868468772930199055502079815422194365220186899549993047142195653428220109192511318189617891422414072869541825096382370935550652939682331396492295833561392918418009658593600292065183962729733563530649943816810545819693080740424733217910783278187728586357039640191108040001917880078272820776036273095983972821660075405709137827278434835612791331910737829138935411072198436259060167992536676748575402165188319033310975424494025065748299770831276568503502149424444843933294528133905275138645872111799795111569092049379634585607392439227227990769992673669298709824907717392759720692571525712477638505579054035577420120287146088364220902118990132000298701189716790477775907960288270560164037144900854105960320145629100053562344301809964605747933', '549632294048505038562638275242250808398936786190142619330826063197867660647913978091714920130241525179440118366553261236710149004983503060836711081007812974364223930533527047493779422964412658287718174688000783682663346470347465048443759059350951663506998888862122295354606947430840330400905626278325125786038494311649830820495720709417773633241796906124864657569381377992935684174429550724205047964940329614313102738513356037715391821239691176601915652379208506816230978713195174911645804814089253418098706933679099719953141323016063030592707021402751663488776023354985911250671144986834095575945758267121197657771661894235533107423836920890392686508366025524106788255744403923148917432846286510392322154971452800735342937051838915469999331655270919729378544426424508565243049098104066440836842740897656176490802047278021043063436493381967734264083620343483688348635186270042084223431304911583547704729913542731482207962640', ['1353035036548180823616557593350235149593153904045395214924516243526022339741387540508001388007263824310099317536124724333537544939913756092488944348824365107148271211248715201338235624176161880236122273605686943974677899827052326451278139124152838613949077236085357719817045027199825720772785524057780217654619141011330788154617831421684639087645115031058537575598160404488276822845299046008034040226702574079655296969483714313675239394044262114449204881441971629124100263689642976248622123173936746276594270267934113023831550178639026475447324473441415522698166227291607562506320226210700665877234921573591887383757444368921346211626414020602298256691346787766566353406176244159180807875700718533305786248115032235550087746731198490704525734308787210166706784529902713684480502167130478481459406593849379943160615508232388851823919219251784293515669726630264690093218511749261407987909455246227729641773135908224413262952022', '1355476328598398243278414207048576018974293096161773658890862702002784104614730264094803160360940779228121183523506789365114899279444822451226984193479745743007165330616418917199270151292321241442079707546857361165240633869151496558777827273557964995804872152534566037104646991687527131963150863951133241363145294170780253911745601443747448783787771443448851122944549331468444096960321287377227469110245373029783896817375211739949762328075849806905712832066687920838222531137721451618453835173674016051763036409615368500579153115663990977095678049890270270570851342401178918207939358480052263988368375698145753098117087000051105496855764879119137290369881524714803135219028176591624107096912255336009843417075766663573818608050874571943883821380049045140092154532826259364913032431573800579963433750058393221192900600372045149501548634516080042650074136952386375140638401633763702653344990733528010850112208035821765000595235'], ['2614267985772886894184317509569892916694699401632404828409578738776831824994906619447935080737203421537416388906652966474508061397685975656593852191607565737368180991979675677636572867773243843962868004287347721648821217582813993280581345893580749475977382921211066571232959560150968987741065108396582231161686895662707934932772315495544616621171113543759650976588187117766579415134501790123698549069081632910256530704923224872655001930060695983622237189512737085312315320360866787916820823993177033252774340799398564360155818381739972024286970903609815512857986107675011501933631730919918239175955807532955155667325356969032510780319857106436875744131653519404742751413691162942181438298245217344968996784963299750609106844704999935019237711681203549899606706388176779484836818831196845335239822554848464492315625437119337836038107299995317200248041583736146735668886825310827491156568812264019833434792501004434736023409439', '3895796024847061959417117449946357088509791621722146585835948032430649729502439307782237865260991975050859067549911703104490343661502769410833020587276344567624907622232213518231034747386541405735391810410317926369063797845715880170370027648146054662138303422570815393261440474636829994886349390693171092285724203444089457365181497533166291482060244226551707545037686886909474232368451664159955025606605941460220632153358127317471110497707025519294199495570048341197434774672336060337181922023649930269589729056398948005755152360902361106001462779415955067495303597349423695757773810949620737888584649132197670971470879525637131673916746181337447065642769197580146857450042411008593319059896877330822151790902518678388943916613841279972728749770930709567786416982036460454517398580381738691140408001685892357033166344729210936426043486518687215000635547644251281876844156039095995135040156609115045547797061421003417145443101', '985581799131106571383715527077046014467938002471837251737723285955864689897333642923908687040982331446482010279083889980499544130558593082598095744729325355347541093018020613663717818463430111064695121976032467220994831992050451625526517052632831995956546198263911782273308252635931886013272949850617998403947985037768969340900793854531808222631785212774204817425295055641068735872643976787014071449171714076550747126171598081851221764101361548104965848133495741984218980130374318122813435265879760512058533200651468808932578174750351811385974807062850060106895602983995575716142191127054528376112610151192202915752272560160053099310222126259914211490899492738739770559137585482856183706287318575381843121251271181838295650099527743731591078038941001335970064141739065697332768099798885921275991025203823990786851163784671969074709461064747456959188939940825877916103758347188472222942647160564375082681394715944640391382809']], ['85135495924905705055856679318705350670233169867386356519831585610048703163626241677756111644121348030234477543188777457233408986202530552992610921771443863767492174546953908425011107616276720775845520096189476657462198002232513146021981871891959116009438425271949247758870054316885029156468744234503734704921159369138419736206215418632224081921740692262503558170546281289601700241516016043711177946252525565951879776163552337520900549718924840195194315507421061729553098506150916003657632280782373689003749358246811606525410333479672150250367364550897639611349429797245765220661209344292221553588270731923247143004193962176590611529956986468648622956344947413842779249903827611311725772218866873599230007933937883575897264415582276837373544705337336845778763670953758886272505817327064256538939687601354924316430978990242868708385342133252365760789305546851057661859320648974294226398354214679736375931955290569032577401025', '1368055697143258654215362814359017702241584970690773731703263379023200482864856754852770734699501000618673022401612691387647209202138662828426186412806972619233710662924323906244783930073787155328185431271740351647606455230539964399652827605343498424377838242230945380109578201502836528246898077014625619473284894241318355723635560231441736522555857648565630592932145818449949623232424164189066202196587855831354531440621742062054032767418049994786198101752581027858495990256487521156823828935795229262508142425156514042093585531408670210101043221379083069067100050585030411097463834351911258450048467679824008360907903883337241190055400622549465745372901594072602290632671499327559521192171064354754202529433705399998798955635285885183151760454058540272961231133748411356408451282135832179879831793238032819718935307242173215494584351842754110853570617582085706633672186457467992022862468943656967251133434039473379003572772', '681439188504940886347921701330590422538387805937824111157341809536097072088009796901930242438241054427545295553215907081085163061788477867688043000112688934713275323162249945173989492734865830678636398037523657930473390281465362213433216171592082184847653382760729223273329437427249079425975250857599822940382733800964287451451033889260593981149116712904476539136434113688438925003274995403465951229936159789245359648961043990675710946884225862317830163641620211708959937688539445430329419448591151224296054139596671027185343228177788284887106084917373007291423710986777597461497250782797587235427980270954331680045340105623319712300716066587544266682574970318856888499876939969816505488308722548968488297918693965304583961039373670335455109387710860115373840511339725381991798254001427839231024012184052624570825487721985962308752171808193414475356128333792935466496695906255045317238173508972014566956100961410486597243327', '656515896378874197451641054075605506813920820666689581613413533660705579821455784356479836346120866473256728648992669570343472396931478169723042812945233928129101168418029318397626877624571257401582795314457612835227406904036342121185606901063448587157234123692467900896089128214560231313747542421717415345400326607198045928342771101197446645325818141896685285465781840386993472510977238180045778359514485615679817772595137333445383373953568462427862112117139604010986247856298512692844771353848454082089964058839411795670191083500963173280965776220050785650643792043260266637033395379464898604081139042160552535795720394328301945859152459500482632181216859396122002025542597662525583466298330064021026953630919621297233481538865413178900539775386182700947896655097511564872388614806660165850200021036272502390857123874364021313336868278411412881072637519928072757201270209421215636307942477552722991968851623679452308852091', ['132632084079803441861112875863696211865129321284969660371641351329778117514545322034265844752510747275713161708216534437651549123460531349655348967684639235575877421845772917269972206310814824582687152371658505389540702797062557290435435085008878284774993582282533179436984705835543763256773152254094360737605739801898826976692887456493701293810019377103732287263823433180979037439603305839023287123527812146921778278196536631555025863131867986302403054114852633219660921297946893619974425935120385635177996372273408185289142681473791331236210186321417541647595909323483695534631492389298901455611383944598139290224540832407911133412266167283601677833276882433316570810942463047266798800308734758494887167913113778519741271416661733050136968780083654226962255752653056212934511247471053034378121525006824624016524479623299096692212821537751889289368365654700880476697937683192232180587048178505320475951513721105804716224667', '793256004408457534661443942113759213930627686110846208903590343684003391365184517601711916712040926420139482437090737539761644681440359122946035889751577817488144282508573371543899903202890922246067272316109904298929193933589681705731557402591650350104606219169196559347156376110982620408759542411104611052011752908938847132222817006401830113286407946062864265244832002963830954910348381093322170731155548902561002529628099921277052459203217993681468844940880673926613393409013896471610201456942745429017446101920216295919944356224258037865876517300877576998085135784556523874597047465696945833810251218892730672188079794866546643149649832931299035254384706516284812337438296497843795258037682369990178543075961442459940455061890569322528985970327671188100159521147135809251919473521929193453544938827542478104338286260435424494862583063069658418314282285322608263360406749924033833630098236120690144807149381693351027259848', '1322702790834028978487893224794528913180885957676590817389276391353968298446361939622385457107339954770832262119444967819553684912467577717736314573215993974146980710859586062632524439017781583036769221420284521946885354551467823395704110949440174682125858260209620422093229559239821894932101634194650488925030309849466815151641714429344854954261228982343185383256851767916019837518330697319739539188876709625759455630732912871620193703578443930994594240359860700040557604370644054933623542213066841584847094249376982330531445730306761573431999559550477286364614729121694336350086003400616696422838090447743237601091512606782901603983746987231984840952181169566127616576847273476971826125963573916213837632300268890912794406171131421066903932012417828101181131680979920395218181578011880196315738164576832309501436184828157477190909988196779858284023330308613253358185320846538255965932257241130473793678642767030704289470223'], ['1878517148374119233571373341128843661569250090285200389184792088332612160610941917207326906065475926505034573341322822128240269900820713333683036127615997249537219456189761215745074606492944012219023147432471968845411248149336376942965763075838873026112098929766152738022605485397086529639332601897368498282475724926269362788159993087482738809905631818685976704428415545875316855395388084440247982511377470876021474308028962946454316640882386346336869472638967878578310610952299984324531629023950821274985628441031838187758109144636472108437720345461487347614073275229890981069614443552427129213386530215257911937517413492573135017490901865379368126117186491067784297477514555311028467566583328473540623742852502837251931757846696253716919380331013927364659209696565798803710921092529700539980087673660333070579968979502445747623934075599002354087483860467183541716838611245151279488148873716531696497450559746449190187204754', '1201039578284884620649231693786477427632176483065208661261237803398489594680200460569417416226606438990299190485482822936477374938569930351768256462468979593165752565927392073634552678436264893727432066049270972465968022899640791831187260521291308799245988304679173723980119087369555688282746574842439059060876477490279561038321105951212678578299138363126051627977266588176629166984970071355110332318474037038038086468686299087037165210499195549476375338169766778653243781308105029789301133159085759997641584199474728912199487508708062746731557628097826664473413161014990886081438118114941125867021297666801053243428619451509730542694821070499504672708680900178211022843605201729134716683290875996055970825010700286616633752473661366075761058225853464423861059414087687064042957398927249013911189768565781573459181412948233338038022940808363049466102334940950905252960925626750777314131769273475693916629593204843423450113043', '1001035605549966437570592262277361877669001253514482762171777343942126541335527240123407970533469108312234521975331686169655106890330255190480306506393122574802252943211586939533331257427233519732797249650584060793081570386311981540216917213208730739506740906419066697967639000969122326344503867869031014709593789947053604052438897365569420610628124017637620009487569092612504169870039745436936781282371946156115795834829910570045292305068578204962642863319864607981884689220126733560583315783027793376094172298067731899609380099338907518579201276578238949632802032054542476129998748456926048968652798548753237166678519460487145237061178997183718771957075050144257441619496871865850180801760192232692729719988035697091281256352472752195568089418833507221261923805192702370377364484022785544246544118006603944311605381200236907712441135237840823761821565471018641839819803225713517340650789800509335395092651923944705742236727']], ['2982175799558336604400109773033690150175235904821223559397349544806063476526939885869018504184669509593845712292506588443297712023809181088617468149454777015783986414210139929539031895194021158850494357244321860460310053492932182543626502970743290879967794306663786688143982617567097802039213544975067717399968646689341541728559781490291923799665958063162618533753499238064050269035709418878238661600369341218002536990167623440342152854706849828048512254531107539810361083986963055736427493986884003904161918503417858510126788981661513025695616699026363379428097177354924657246710763217599798606315855114036918908751334738189211650303563520379732356709176914731024568582164548255420657490924882894287311256339542807086591497729044241476905156361838872741998490701039177501844328030328494910569919930767834033980009009612021044043735311183110871902223967197037138516419111645163264869932922311082613053795518623951702929570511', '3762053468234706666063122157887779098077686267317956656807384758242378786143285167434585810856818004509578757122013147999399509849988794506094723955406942417461741483485474049164805932810402122260391882050885870546197018960404505593575022093260708269883520038565783580263281736821780883513646018928041155245604580049832270132399630550396752565299040924369797479975165721298151649767382044672397324581394842734368757984814782451874891342006948319088517007245862266481894050738642756158483920500135751258617857893313241843854081783124262319820253216613731067514391601694396836209996619468584896666443394048187387862567745283795171046265509331359017541829156485648004464505235527286164521394829928629386492700715543490370966870954807715265533467983096893610220098967491816402946263421304779634110289354946341012715876467613878982691840464315267200516840187464980565579015545239026818764142066143907206070016602979118840837926619', '2452051096590804255103235451615443640583934189111652483050265925343546427739839702267367581175387204482130017975105916864162312064496652714490302664094308978621992061857475992357049576450246529259664488178948948392545927454195345141885209956814750601103457573811025024691876708166832311055391151032476721530138381657201731919803995533384824185774515933662903519477560248485005746368588857948642746749429877546774490302578354831621110558936018353981111921927307263535378997832238578942815422095391587781987466130856105560309681495809934222501390320602778722825881871903298865753951064475088833259157789331099569332834877863396804622090456390906179862111393621655630219051784454696070016357543344943778296052336133049253956347388491158668235568961567322711890621598264810175210049926693240531163858434144676790240717420801464712386498046786389994541003250399026510493345648071751934041185477020352253830367395121149090256963465'], ['3878512475332124260862310438329614370552989933380718568135529154010054420623659456546087401301293471016975827577798771560979765983632983246147519433474505613336105349112985510829083068213975755341043523054261492104104162876814022957360261115180488348371264976428680899735356232532728725239467453642915426636155739819302157604921287043236865183570819611816684075660624585290106385733084491802849195845372611098727153687834523804395881886103460000950120504171228296285210344141615418663402487015106290553271104604080735431603926750398268264887216652509613864225426905481047738380167512731713579120746405666546580113048761508643525877196017499486515122695975073517013617498719735441552189090503188098499399691983318939074578581520579992399865718620151183845066653857459449455456975998055889984951038679944755484142167267583602949701032442790080457656047523289991442836877298620185499709794280239356755096776178926370284483283699', '3425600022911430570310722110019879414024030111972911649988123066029865382461387113812638128076308532951525887855934027718967986698060025455772171774723698959677436875450325391029709897218339068101244529210093747361863178525825481590471412439185020389360896255929328485900004799828870643998523768364198506398671639269390402024508763376133137576004565413792687959477373873256385936068798653912769214541723158794292089515262827533597646230459577474589626200482011984405194138993816760956445916798699308488607657070017291142948220182974430839445341596459021539149648929582908227573455151295086874442183075050647096232313360168403132910295025934180815551808159034436442022358723003563059120590411264993506739028129557812067709476140138097723145430516620732947518205482439288966610315598024354314264866646157996407990828120453683918280246403249453406092047372875630901488438646954268840736778709286252813750279446806675527461989421', '957612535583297116848181642522746934097977445476906965565137367273466000353972728199582665611662480875324613946961400473969323972981158936704924538466104907477044115818857624694339012285954101418332890970223563906975196561090214430324332789863385462877577091062053672626414004031437257358702248367010777259636671900428612305865172008978463188644429811700676152889778768544478627790206798168178203323858647032791280880333463706115761158148609384143648929161909692218553771424747780888460081780517887558149906791768854377112954745360216583182038303002241378804985994167518197921020576971794133535690421020383737352783490098014768509004388651007427621046041373068398507923477658772302721803740965396309509920902118894018087838321837372424235083638331303697985030890831863095305152025284828433979381455701477246167083357264747255870761931302356881405232988440076420483006821889721014101747968800415198263641875352253281585105810']]})
        >>> res.test_result
        'successful'
        """
        pi = self.test_data
        N = self.election_data['N']
        param = self.election_data['secparams']
        res_pi_t_0 = multiMathGroupeHelper(pi[0][:3],3,param.p)
        res_pi_t_1 = multiMathGroupeHelper(pi[0][3],2,param.p)
        res_pi_t_2 = multiMathGroupeHelper(pi[0][4],N,param.p)
        res_pi_t = res_pi_t_0 and res_pi_t_1 and res_pi_t_2
        res_pi_s_0 = multiRangeTestHelper(pi[1][:4],4,param.q)
        res_pi_s_1 = multiRangeTestHelper(pi[1][4],N,param.q)
        res_pi_s_2 = multiRangeTestHelper(pi[1][5],N,param.q)
        res_pi_s = res_pi_s_0 and res_pi_s_1 and res_pi_s_2
        res_c_bold = multiMathGroupeHelper(pi[2],N,param.p)
        res_c_hat_bold = multiMathGroupeHelper(pi[3],N,param.p)
        res_pi = res_pi_t and res_pi_s and res_c_bold and res_c_hat_bold
        self.test_result.addTestData('p',param.p)
        self.test_result.addTestData('q',param.q)
        self.test_result.addTestData('N',N)
        return 'successful' if res_pi else 'failed'

if __name__ == '__main__':
    import doctest
    from chvote.Common.SecurityParams import secparams_l1,secparams_l2,secparams_l3
    from chvote.verifier.TestResult import TestResult
    from app.verifier.Report import Report
    TestResult.setReport(Report("1"))
    spi_test = ShuffleProofIntegrityTest("1.1","TEST","TEST",["pi_j"])
    spi_test.election_data = {'secparams': secparams_l3,'N': 3}
    doctest.testmod(extraglobs={'spit': spi_test})
